<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://kit.fontawesome.com/1147679ae7.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <title>2HandHub.com</title>
  <style>
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid #eee;
      background-color: white;
    }

    .logo img {
      height: 75px;
    }

    .search-bar {
      display: flex;
      align-items: center;
      width: 150px;
      /* ƒê·ªïi t·ª´ 30px sang 320px ho·∫∑c gi√° tr·ªã b·∫°n mu·ªën */
      background: #f5f5f5;
      border-radius: 6px;
      padding: 6px 12px;
    }





    @media (max-width: 768px) {
      .search-box {
        max-width: 100%;
      }
    }

    .notification-wrapper {
      position: relative;
    }

    .notification-indicator {
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      position: absolute;
      top: -4px;
      right: -4px;
      z-index: 2;
    }

    .notification-popup {
      position: absolute;
      top: 36px;
      right: 0;
      width: 360px;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 16px;
      border-radius: 8px;
      z-index: 1000;
    }

    .notification-popup.hidden {
      display: none;
    }

    .notification-popup p {
      margin: 0 0 10px;
      font-size: 14px;
      color: #333;
    }

    .latest-products h2 {
      font-size: 26px;
      text-align: center;
      color: #222;
      margin-top: 40px;
      margin-bottom: 20px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
      margin-top: 12px;
      flex-wrap: nowrap;
      /* NgƒÉn c√°c n√∫t xu·ªëng d√≤ng */
      align-items: center;
    }

    .action-buttons button {
      background: #eee;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease;
    }

    .action-buttons button:hover {
      background-color: #ccc;
    }


    .right-icons {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .right-icons i,
    .right-icons .username {
      font-size: 16px;
      color: #333;
    }

    .post-button {
      background-color: #ff3b30;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      white-space: nowrap;
    }

    .sub-menu {
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      background-color: #fff;
      border-bottom: 1px solid #eee;
    }

    .menu-link {
      text-decoration: none;
      color: #333;
      font-weight: 500;
      padding: 6px 10px;
      position: relative;
    }

    .menu-link.active {
      color: #e60023;
    }

    .menu-link.active::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #e60023;
      margin-top: 4px;
    }

    .menu-link:hover {
      color: #e60023;
    }

    .cart-wrapper {
      position: relative;
      cursor: pointer;
    }

    .cart-popup {
      position: absolute;
      top: 36px;
      right: 0;
      width: 340px;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 16px;
      border-radius: 8px;
      z-index: 1000;
    }

    .cart-popup.hidden {
      display: none;
    }

    .cart-items {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    .cart-popup p {
      margin: 6px 0;
      font-size: 14px;
      color: #333;
    }

    .cart-total {
      font-weight: bold;
      text-align: right;
      margin-bottom: 12px;
    }

    .cart-icon-container {
      position: relative;
      cursor: pointer;
    }

    .cart-badge {
      position: absolute;
      top: -6px;
      right: -10px;
      background: red;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 50%;
    }

    #cartPopup {
      position: absolute;
      top: 70px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      width: 320px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      display: none;
      z-index: 999;
      animation: slideDown 0.3s ease;
      max-height: 400px;
      overflow-y: auto;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cart-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
      display: flex;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
    }

    .cart-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
    }

    .cart-item-info {
      flex: 1;
    }

    .remove-btn {
      color: #e60023;
      cursor: pointer;
      font-size: 14px;
      border: none;
      background: none;
    }

    .total-price {
      text-align: right;
      font-weight: bold;
      margin-top: 12px;
    }

    #cartPopup {
      position: absolute;
      top: 36px;
      /* ho·∫∑c 40px */
      right: 0;
      background: white;
      border: 1px solid #ddd;
      padding: 16px;
      width: 320px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      display: none;
      z-index: 999;
      animation: slideDown 0.3s ease;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="logo">
      <img src="image/2hand.png" alt="logo" />
    </div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." />
      <i class="fas fa-search"></i>
    </div>
    <div class="right-icons">
      <div class="notification-wrapper">
        <div class="notification-indicator" id="notifDot"></div>
        <i class="fa fa-bell" id="notifIcon"></i>
        <div class="notification-popup hidden" id="notificationBox">
          <div id="notificationContent">
            <p>ƒêang t·∫£i th√¥ng b√°o...</p>
          </div>
        </div>
      </div>
      <a href="user.html" class="username" target="_blank" id="username-link"></a>

      <script>
        // Load notifications from server
        function loadNotifications() {
          const user = JSON.parse(localStorage.getItem("user"));
          fetch(`https://localhost:7238/api/Notification/get-all-notifications?currentId=${user.id}`)
            .then(res => res.json())
            .then(data => {
              const notificationContent = document.getElementById('notificationContent');
              if (!data || data.length === 0) {
                notificationContent.innerHTML = '<p>Kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>';
                return;
              }

              let html = '<p><strong>üì¢ Th√¥ng b√°o</strong></p>';
              data.data.forEach((notification, index) => {
                html += `
             <div class="notification-item" style="border-bottom: 1px solid #eee; padding: 12px 0;">
             <p style="margin: 0 0 8px 0;"><strong>${notification.title || 'Th√¥ng b√°o'}</strong></p>
             <p style="margin: 0 0 12px 0; font-size: 13px; color: #666;">${notification.content || notification.messeage || 'N·ªôi dung th√¥ng b√°o'}</p>
             <div class="action-buttons">
               <button onclick="respond('accepted', ${notification.id || index})">‚úÖ ƒê·ªìng √Ω</button>
               <button onclick="respond('rejected', ${notification.id || index})">‚ùå T·ª´ ch·ªëi</button>
               <button onclick="respond('chat', ${notification.id || index})">üí¨ Tr·∫£ l·ªùi</button>
             </div>
             </div>
           `;
              });
              notificationContent.innerHTML = html;
            })
            .catch(error => {
              console.error('Error loading notifications:', error);
              document.getElementById('notificationContent').innerHTML = '<p>L·ªói khi t·∫£i th√¥ng b√°o.</p>';
            });
        }

        // Update the respond function to handle notification ID
        window.respond = function (action, notificationId) {
          switch (action) {
            case 'accepted':
              alert(`‚úÖ B·∫°n ƒë√£ ƒë·ªìng √Ω th√¥ng b√°o #${notificationId}. Gi√° m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`);
              break;
            case 'rejected':
              alert(`‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi th√¥ng b√°o #${notificationId}.`);
              break;
            case 'chat':
              window.location.href = "chat.html";
              break;
            default:
              alert("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
          }
          document.getElementById('notificationBox').classList.add('hidden');
        };

        // Load notifications when bell icon is clicked
        document.getElementById('notifIcon').addEventListener('click', function (e) {
          e.stopPropagation();
          const notificationBox = document.getElementById('notificationBox');
          if (notificationBox.classList.contains('hidden')) {
            loadNotifications();
          }
          notificationBox.classList.toggle('hidden');
          document.getElementById('notifDot').style.display = 'none';
        });
      </script>
      <script>
        // L·∫•y t√™n ng∆∞·ªùi d√πng t·ª´ localStorage v√† hi·ªÉn th·ªã
        const user = JSON.parse(localStorage.getItem("user"));
        const userId = user && user.id ? user.id : 1;
        const username = user.fullName || "Mizu";
        document.getElementById('username-link').textContent = username;
      </script>
      <div class="cart-icon-container">
        <i class="fa fa-shopping-bag" id="cartIcon"></i>
        <span class="cart-badge" id="cartCount">0</span>

        <!-- ‚úÖ Move this popup INSIDE the cart container -->
        <div id="cartPopup" class="cart-popup hidden"></div>


      </div>
      <a href="post.html" class="post-button">ƒêƒÉng b√°n</a>
    </div>
  </div>

  <div class="sub-menu">
    <a href="#" class="menu-link active">G·ª¢I √ù</a>
    <a href="style.html" class="menu-link">TH·ªúI TRANG</a>
    <a href="book.html" class="menu-link">S√ÅCH</a>
    <a href="hh.html" class="menu-link">ƒê·ªí GIA D·ª§NG</a>
    <a href="elec.html" class="menu-link">ƒê·ªí ƒêI·ªÜN T·ª¨</a>
    <a href="play.html" class="menu-link">ƒê·ªí GI·∫¢I TR√ç</a>
  </div>

  <!-- Slider, G·ª£i √Ω, Kh√°m ph√°, B√†i ƒëƒÉng m·ªõi (gi·ªØ nguy√™n n·ªôi dung ·ªü ph·∫ßn sau c·ªßa b·∫°n n·∫øu c·∫ßn) -->
  <section id="Slider">
    <div class="slider-wrapper">
      <img src="image/menu00.jpg" alt="">
      <img src="image/menu1.png" alt="">
      <img src="image/menu2.png" alt="">
      <img src="image/menu3.png" alt="">
    </div>
  </section>
  <section id="search-results" style="display:none; padding: 20px;">
    <h2>K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
    <div id="searchList" class="suggest-grid"></div>
  </section>
  <section class="latest-products">
    <h2>G·ª£i √Ω h√¥m nay d√†nh cho b·∫°n</h2>
    <div id="productList1" class="suggest-grid"></div>
  </section>

  <section class="latest-products">
    <h2>Kh√°m ph√° danh m·ª•c</h2>
    <div id="productList2" class="suggest-grid"></div>
  </section>

  <section class="latest-products">
    <h2>B√†i ƒëƒÉng m·ªõi</h2>
    <div id="productList3" class="suggest-grid"></div>
  </section>

  <script>
    // ...existing code...
    fetch(`https://localhost:7238/api/Product/get-suggested-products?PageNumber=1&PageSize=12&UserId=${userId}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('productList1');
        container.innerHTML = ""; // X√≥a n·ªôi dung c≈© n·∫øu c√≥
        data.data.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          // Format price to "117.000 ƒë"
          function formatPrice(price) {
            if (typeof price === "number") price = price.toString();
            price = price.replace(/\D/g, "");
            return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ƒë";
          }
          card.innerHTML = `
        <img src="${product.image}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>${formatPrice(product.price)}</p>
      `;
          card.style.cursor = "pointer";
          card.onclick = function () {
            localStorage.setItem('selectedProduct', JSON.stringify(product));
            window.location.href = 'sp.html';
          };
          container.appendChild(card);
        });
      })
      .catch(error => {
        console.error('L·ªói khi t·∫£i b√†i ƒëƒÉng m·ªõi:', error);
      });

    fetch('MockData/kham_pha.json')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('productList2');
        data.forEach((product, index) => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.innerHTML = `
        <img src="${product.image}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>${product.price}</p>
      `;
          card.style.cursor = "pointer";

          // G√°n ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ·ª©ng d·ª±a theo index
          card.onclick = function () {
            switch (index) {
              case 0:
                window.location.href = 'style.html';
                break;
              case 1:
                window.location.href = 'book.html';
                break;
              case 2:
                window.location.href = 'hh.html';
                break;
              case 3:
                window.location.href = 'play.html';
                break;
              default:
                alert("Danh m·ª•c ch∆∞a ƒë∆∞·ª£c g√°n li√™n k·∫øt.");
            }
          };

          container.appendChild(card);
        });
      });


    fetch('https://localhost:7238/api/Product/get-recent-products?PageNumber=1&PageSize=20')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('productList3');
        container.innerHTML = ""; // X√≥a n·ªôi dung c≈© n·∫øu c√≥
        data.data.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          // Format price to "117.000 ƒë"
          function formatPrice(price) {
            if (typeof price === "number") price = price.toString();
            price = price.replace(/\D/g, "");
            return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ƒë";
          }
          card.innerHTML = `
        <img src="${product.image}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>${formatPrice(product.price)}</p>
      `;
          card.style.cursor = "pointer";
          card.onclick = function () {
            localStorage.setItem('selectedProduct', JSON.stringify(product));
            window.location.href = 'sp.html';
          };
          container.appendChild(card);
        });
      })
      .catch(error => {
        console.error('L·ªói khi t·∫£i b√†i ƒëƒÉng m·ªõi:', error);
      });

    // ...existing code...

    // window.onload = function () {
    //   // === Notification icon ===
    //   const bellIcon = document.getElementById('notifIcon');
    //   const notificationBox = document.getElementById('notificationBox');
    //   const notifDot = document.getElementById('notifDot');

    //   let bellClickCount = 0; //thong b√°o s·ªë l·∫ßn click chu·ªôt v√†o bi·ªÉu t∆∞·ª£ng chu√¥ng
    // let bellClickTimer;
    // bellIcon.addEventListener('click', (e) => {
    //   e.stopPropagation();
    //   bellClickCount++;

    //   clearTimeout(bellClickTimer); // reset timer m·ªói khi click

    //   bellClickTimer = setTimeout(() => {
    //     if (bellClickCount === 1) {
    //       notificationBox.classList.toggle('hidden');
    //       notifDot.style.display = 'none';
    //     } else if (bellClickCount === 2) {
    //       showAgreedPopup();
    //     } else if (bellClickCount === 3) {
    //       showRejectedPopup();
    //     } else if (bellClickCount === 4) {
    //       showChat();
    //     }
    //     bellClickCount = 0; // reset l·∫°i sau x·ª≠ l√Ω
    //   }, 300); // 300ms ƒë·ªÉ ph√°t hi·ªán chu·ªói click
    // });


    document.addEventListener('click', (e) => {
      if (!notificationBox.contains(e.target) && !bellIcon.contains(e.target)) {
        notificationBox.classList.add('hidden');
      }
    });

    window.respond = function (action) {
      switch (action) {
        case 'accepted':
          alert("‚úÖ B·∫°n ƒë√£ ƒë·ªìng √Ω gi√° th∆∞∆°ng l∆∞·ª£ng. Gi√° m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
          break;
        case 'rejected':
          alert("‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi y√™u c·∫ßu th∆∞∆°ng l∆∞·ª£ng.");
          break;
        case 'chat':
          window.location.href = "chat.html";
          break;
        default:
          alert("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
      }
      notificationBox.classList.add('hidden');
    };
    function showAgreedPopup() { //thong bao dong y thuong luong
      notificationBox.innerHTML = `
    <div style="
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    ">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-check-circle" style="color: #2ecc71; font-size: 20px;"></i>
        <p style="margin: 0; font-size: 15px; color: #333; font-weight: 500;">
          Ng∆∞·ªùi b√°n ƒë√£ ƒë·ªìng √Ω v·ªõi y√™u c·∫ßu th∆∞∆°ng l∆∞·ª£ng gi√° c·ªßa b·∫°n.
        </p>
      </div>
      <button onclick="proceedToPayment()" style="
        background-color: #e60023;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.2s ease;
      ">Mua ngay</button>
    </div>
  `;
      notificationBox.classList.remove('hidden');
    }
    function showRejectedPopup() {
      notificationBox.innerHTML = `
    <div style="
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    ">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-times-circle" style="color: #e74c3c; font-size: 20px;"></i>
        <p style="margin: 0; font-size: 15px; color: #333; font-weight: 500;">
          Ng∆∞·ªùi b√°n ƒë√£ t·ª´ ch·ªëi y√™u c·∫ßu th∆∞∆°ng l∆∞·ª£ng c·ªßa b·∫°n.
        </p>
      </div>
    </div>
  `;
      notificationBox.classList.remove('hidden');
    }

    function showChat() {
      notificationBox.innerHTML = `
    <div style="
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      cursor: pointer;
    " id="chatPopupContent">
      <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-comments" style="color: #3498db; font-size: 20px;"></i>
        <p style="margin: 0; font-size: 15px; color: #333; font-weight: 500;">
          Ng∆∞·ªùi b√°n ƒë√£ g·ª≠i tin nh·∫Øn cho b·∫°n !!!
        </p>
      </div>
    </div>
  `;
      notificationBox.classList.remove('hidden');
      // Th√™m s·ª± ki·ªán click ƒë·ªÉ chuy·ªÉn sang chat.html
      document.getElementById('chatPopupContent').onclick = function () {
        window.location.href = "chat.html";
      };
    }

    // === Gi·ªè h√†ng ===
    const cartCount = document.getElementById('cartCount');
    const cartPopup = document.getElementById('cartPopup');
    let cart = [];

    fetch(`https://localhost:7238/api/Cart/get-items?userId=${userId}`)
      .then(res => res.json())
      .then(data => {
        cart = data || [];
        updateCartUI();
      })
      .catch(error => {
        console.error('Error fetching cart items:', error);
        // Fallback to localStorage if server request fails
        cart = JSON.parse(localStorage.getItem('cartItems')) || [];
        updateCartUI();
      });

    function formatPrice(price) {
      if (typeof price === "number") price = price.toString();
      price = price.replace(/\D/g, "");
      return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "ƒë";
    }

    function updateCartUI() {
      cartCount.textContent = cart.length;
      if (cart.length === 0) {
        cartPopup.innerHTML = '<p>üõí Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>';
        return;
      }
      let html = '<h4 style="margin-top:0;">üõí Gi·ªè h√†ng:</h4>';
      let total = 0;

      cart.forEach((item, index) => {
        total += parseInt(item.price.replace(/\D/g, ''));
        html += `
        <div class="cart-item">
          <img src="${item.image}" alt="${item.name}" />
          <div class="cart-item-info" onclick="viewProduct(${index})" style="cursor:pointer;">
            <strong>${item.name}</strong><br>
            ${formatPrice(item.price)}
          </div>
          <button class="remove-btn" onclick="removeItem(${index})">‚úï</button>
        </div>
      `;
      });

      html += `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px; gap: 12px;">
        <div class="total-price" style="margin:0;">T·ªïng: ${formatPrice(total.toString())}</div>
        <button class="action-button primary" onclick="proceedToPayment()" style="flex-shrink: 0;">Thanh to√°n</button>
      </div>
    `;

      cartPopup.innerHTML = html;
    }

    window.removeItem = function (index) {
      cart.splice(index, 1);
      localStorage.setItem('cartItems', JSON.stringify(cart));
      updateCartUI();
    };

    window.viewProduct = function (index) {
      const product = cart[index];
      localStorage.setItem('selectedProduct', JSON.stringify(product));
      window.location.href = 'sp.html';
    };

    window.proceedToPayment = function () {
      if (cart.length === 0) {
        alert("Gi·ªè h√†ng tr·ªëng!");
        return;
      }
      localStorage.setItem('cartToPay', JSON.stringify(cart));
      window.location.href = 'pay.html';
    };

    document.querySelector('.cart-icon-container').addEventListener('click', (e) => {
      cartPopup.classList.toggle('hidden');
      e.stopPropagation();
    });

    document.addEventListener('click', function (event) {
      const isInside = cartPopup.contains(event.target) || event.target.closest('.cart-icon-container');
      if (!isInside) cartPopup.classList.add('hidden');
    });

    updateCartUI();

  </script>

  <footer>
    <p>&copy; 2023 2HandHub.com - All rights reserved.</p>
  </footer>

  <script>
    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng
    const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
    document.getElementById('cartCount').textContent = cartItems.length;
  </script>

  <script>
    const searchInput = document.getElementById("searchInput");
    const searchSection = document.getElementById("search-results");
    const searchList = document.getElementById("searchList");

    function formatPrice(price) {
      if (typeof price === "number") price = price.toString();
      price = price.replace(/\D/g, "");
      return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ƒë";
    }

    function renderProduct(container, product) {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
      <img src="${product.image}" alt="${product.name}">
      <h3>${product.name}</h3>
      <p>${formatPrice(product.price)}</p>
    `;
      card.style.cursor = "pointer";
      card.onclick = function () {
        localStorage.setItem("selectedProduct", JSON.stringify(product));
        window.location.href = "sp.html";
      };
      container.appendChild(card);
    }

    searchInput.addEventListener("input", () => {
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(() => {
        const keyword = searchInput.value.trim();
        if (!keyword) {
          searchSection.style.display = "none";
          searchList.innerHTML = "";
          return;
        }

        fetch(`https://localhost:7238/api/Product/search-by-name?PageNumber=1&PageSize=20&Name=${encodeURIComponent(keyword)}`)
          .then((res) => res.json())
          .then((data) => {
            searchList.innerHTML = "";
            const products = data.data || [];
            searchSection.style.display = "block";
            if (products.length === 0) {
              searchList.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p.</p>";
              return;
            }
            products.forEach((product) => renderProduct(searchList, product));
          })
          .catch((err) => {
            searchList.innerHTML = "<p>ƒê√£ x·∫£y ra l·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m.</p>";
            searchSection.style.display = "block";
            console.error("L·ªói t√¨m ki·∫øm:", err);
          });
      }, 300);
    });
  </script>
  <!-- Connect to SignalR -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // T·∫°o k·∫øt n·ªëi t·ªõi NotificationHub
      const user = JSON.parse(localStorage.getItem("user"));
      const connection = new signalR.HubConnectionBuilder()
        .withUrl(`https://localhost:7238/notification?userId=${user.id}`) // ho·∫∑c "/hubs/notification" tu·ª≥ c·∫•u h√¨nh server
        .withAutomaticReconnect()
        .configureLogging(signalR.LogLevel.Information)
        .build();

      // ƒê·ªãnh nghƒ©a s·ª± ki·ªán nh·∫≠n t·ª´ server
      connection.on("ReceiveNotification", function (notification) {
        console.log("Th√¥ng b√°o m·ªõi:", notification);

        // Hi·ªÉn th·ªã ch·∫•m ƒë·ªè th√¥ng b√°o
        const notifDot = document.getElementById('notifDot');
        if (notifDot) {
          notifDot.style.display = 'block';
        }

        // C√≥ th·ªÉ hi·ªÉn th·ªã toast notification
        if (notification.Title && notification.Message) {
          // T·∫°o m·ªôt th√¥ng b√°o t·∫°m th·ªùi
          const toast = document.createElement('div');
          toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 300px;
            animation: slideIn 0.3s ease;
          `;
          toast.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 8px;">${notification.Title}</div>
            <div style="font-size: 14px; color: #666;">${notification.Message}</div>
          `;
          document.body.appendChild(toast);

          // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
          setTimeout(() => {
            toast.remove();
          }, 5000);
        }
      });

      // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi
      connection.start()
        .then(function () {
          console.log("ƒê√£ k·∫øt n·ªëi ƒë·∫øn NotificationHub");
          // G·ª≠i message l√™n n·∫øu c·∫ßn: connection.invoke("SomeMethod", ...)
        })
        .catch(function (err) {
          console.error("L·ªói khi k·∫øt n·ªëi SignalR:", err.toString());
        });
    });
  </script>

</body>

</html>