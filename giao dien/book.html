<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S√°ch - 2HandHub</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://kit.fontawesome.com/1147679ae7.js"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: #f7f7f7;
      }
     .navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #eee;
        background-color: white;
      }

      .logo img {
        height: 75px;
      }

      .search-bar {
        display: flex;
        align-items: center;
        width: 150px;
        /* ƒê·ªïi t·ª´ 30px sang 320px ho·∫∑c gi√° tr·ªã b·∫°n mu·ªën */
        background: #f5f5f5;
        border-radius: 6px;
        padding: 6px 12px;
      }

      @media (max-width: 768px) {
        .search-box {
          max-width: 100%;
        }
      }

      .notification-wrapper {
        position: relative;
      }

      .notification-indicator {
        width: 10px;
        height: 10px;
        background-color: red;
        border-radius: 50%;
        position: absolute;
        top: -4px;
        right: -4px;
        z-index: 2;
      }

      .notification-popup {
        position: absolute;
        top: 36px;
        right: 0;
        width: 360px;
        background: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 16px;
        border-radius: 8px;
        z-index: 1000;
      }

      .notification-popup.hidden {
        display: none;
      }

      .notification-popup p {
        margin: 0 0 10px;
        font-size: 14px;
        color: #333;
      }

     .latest-products {
        padding: 40px 24px 0;
      }

      .latest-products h2 {
        font-size: 22px;
        color: #222;
        margin-bottom: 20px;
        text-transform: uppercase;
        border-left: 4px solid #e60023;
        padding-left: 10px;
      }

      .suggest-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 60px;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        padding: 12px;
        text-align: center;
        transition: transform 0.3s;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }

      .product-card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .product-card h3 {
        font-size: 15px;
        font-weight: 600;
        margin: 10px 0 4px;
        color: #333;
      }

      .product-card p {
        color: #e60023;
        font-weight: bold;
        font-size: 15px;
      }
      .action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: nowrap;
        align-items: center;
      }

      .action-buttons button {
        background: #eee;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background-color 0.2s ease;
      }

      .action-buttons button:hover {
        background-color: #ccc;
      }

      .right-icons {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .right-icons i,
      .right-icons .username {
        font-size: 16px;
        color: #333;
      }

      .post-button {
        background-color: #ff3b30;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: bold;
        text-decoration: none;
        white-space: nowrap;
      }

      .sub-menu {
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        background-color: #fff;
        border-bottom: 1px solid #eee;
      }

      .menu-link {
        text-decoration: none;
        color: #333;
        font-weight: 500;
        padding: 6px 10px;
        position: relative;
      }

      .menu-link.active {
        color: #e60023;
      }

      .menu-link.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #e60023;
        margin-top: 4px;
      }

      .menu-link:hover {
        color: #e60023;
      }

      .cart-wrapper {
        position: relative;
        cursor: pointer;
      }

      .cart-popup {
        display: block;
        position: absolute;
        top: 36px;
        right: 0;
        width: 340px;
        background: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 16px;
        border-radius: 8px;
        z-index: 1000;
      }

      .cart-popup.hidden {
        display: none;
      }

      .cart-items {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 12px;
      }

      .cart-popup p {
        margin: 6px 0;
        font-size: 14px;
        color: #333;
      }

      .cart-total {
        font-weight: bold;
        text-align: right;
        margin-bottom: 12px;
      }

      .cart-icon-container {
        position: relative;
        cursor: pointer;
      }

      .cart-badge {
        position: absolute;
        top: -6px;
        right: -10px;
        background: red;
        color: white;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 50%;
      }

      #cartPopup {
        position: absolute;
        top: 70px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        padding: 16px;
        width: 320px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
        display: none;
        z-index: 999;
        animation: slideDown 0.3s ease;
        max-height: 400px;
        overflow-y: auto;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .cart-item {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
        display: flex;
        gap: 12px;
        justify-content: space-between;
        align-items: center;
      }

      .cart-item img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
      }

      .cart-item-info {
        flex: 1;
      }

      .remove-btn {
        color: #e60023;
        cursor: pointer;
        font-size: 14px;
        border: none;
        background: none;
      }

      .total-price {
        text-align: right;
        font-weight: bold;
        margin-top: 12px;
      }

      #cartPopup {
        position: absolute;
        top: 36px;
        /* ho·∫∑c 40px */
        right: 0;
        background: white;
        border: 1px solid #ddd;
        padding: 16px;
        width: 320px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
        display: none;
        z-index: 999;
        animation: slideDown 0.3s ease;
        max-height: 400px;
        overflow-y: auto;
      }
      .action-button {
        padding: 12px 20px;
        border-radius: 10px;
        border: none;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .action-button.add {
        background: #f5f5f5;
        color: #333;
      }

      .action-button.add:hover {
        background: #e2e2e2;
      }

      .action-button.discount {
        background: #fff0f0;
        color: #cc0033;
      }

      .action-button.discount:hover {
        background: #ffe5e5;
      }

      .action-button.primary {
        background: #e60023;
        color: #fff;
      }

      .action-button.primary:hover {
        background: #c4001c;
      }
     .notification-item {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      margin-bottom: 6px;
    }

    .notification-header strong {
      color: #000;
      font-weight: 600;
    }

    .notification-content {
      font-size: 13px;
      color: #555;
      margin: 0 0 8px;
    }

    .remove-btn {
      font-size: 16px;
      color: crimson;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="logo">
      <img src="image/2hand.png" alt="logo" />
    </div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." />
      <i class="fas fa-search"></i>
    </div>
    <div class="right-icons">
      <div class="notification-wrapper">
        <div class="notification-indicator" id="notifDot"></div>
        <i class="fa fa-bell" id="notifIcon"></i>
        <div class="notification-popup hidden" id="notificationBox">
          <div id="notificationContent">
            <p>ƒêang t·∫£i th√¥ng b√°o...</p>
          </div>
        </div>
      </div>
      <a href="user.html" class="username" target="_blank" id="username-link"></a>

      <script>

        function loadNotifications() {
          const user = JSON.parse(localStorage.getItem("user"));
          fetch(
            `https://localhost:7238/api/Notification/get-all-notifications?currentId=${user.id}`
          )
            .then((res) => res.json())
            .then((data) => {
              const notificationContent = document.getElementById(
                "notificationContent"
              );
              if (!data || data.length === 0) {
                notificationContent.innerHTML =
                  "<p>Kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>";
                return;
              }

              if (!data || !data.data || data.data.length === 0) {
                notificationContent.innerHTML =
                  "<p>Kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>";
                return;
              }

              let html = "<p><strong>üì¢ Th√¥ng b√°o</strong></p>";
              data.data.forEach((notification, index) => {
                let actionButtons = '';
                if (notification.type === 1) {
                  actionButtons = `
          <button onclick="respond('accepted', ${JSON.stringify(notification).replace(/"/g, '&quot;')})">‚úÖ ƒê·ªìng √Ω</button>
          <button onclick="respond('rejected', ${JSON.stringify(notification).replace(/"/g, '&quot;')})">‚ùå T·ª´ ch·ªëi</button>
          <button onclick="respond('chat', ${JSON.stringify(notification).replace(/"/g, '&quot;')})">üí¨ Tr·∫£ l·ªùi</button>
          `;
                } else if (notification.type === 2) {
                  actionButtons = `
          <button onclick="respond('chat', ${JSON.stringify(notification).replace(/"/g, '&quot;')})">üí¨ Tr·∫£ l·ªùi</button>
          `;
                } else if (notification.type === 3) {
                  actionButtons = '';
                }

                html += `
  <div class="notification-item">
    <div class="notification-header">
      <strong>${notification.title || "Th√¥ng b√°o"}</strong>
      <button class="remove-btn" onclick="event.stopPropagation(); removeNotification(${notification.id})">‚úï</button>
    </div>
    <p class="notification-content">
      ${notification.content || notification.messeage || "N·ªôi dung th√¥ng b√°o"}
    </p>
    <div class="action-buttons">
      ${actionButtons}
    </div>
  </div>
`;
                ;

              });
              notificationContent.innerHTML = html;
            })
            .catch((error) => {
              console.error("Error loading notifications:", error);
              document.getElementById("notificationContent").innerHTML =
                "<p>L·ªói khi t·∫£i th√¥ng b√°o.</p>";
            });
        }

        function removeNotification(notificationId) {
          fetch(`https://localhost:7238/api/Notification/remove-notification?notificationId=${notificationId}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) throw new Error("X√≥a th·∫•t b·∫°i");
              return res.json();
            })
            .then(() => {
              loadNotifications(); // L√†m m·ªõi danh s√°ch th√¥ng b√°o
            })
            .catch((err) => {
              console.error("L·ªói khi x√≥a th√¥ng b√°o:", err);
            });
        }



        window.respond = async function (action, notification) {
          switch (action) {
            case "accepted":

              let negotiatedPrice = null;
              const productId = notification.productId;


              if (notification.message || notification.messeage) {
                const message = notification.message || notification.messeage;
                const priceMatch = message.match(/‚Ç´([\d,.]+)/);
                if (priceMatch) {

                  negotiatedPrice = parseInt(priceMatch[1].replace(/[,.]/g, ''));
                }
              }

              if (!negotiatedPrice || !productId) {
                alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi√° - thi·∫øu th√¥ng tin c·∫ßn thi·∫øt.");
                return;
              }

              const payload = {
                id: productId,
                price: Number(negotiatedPrice),
                isDeleted: true
              };

              try {
                const res = await fetch("https://localhost:7238/api/Product/update-product", {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success || data.status === 200) {
                  alert(`‚úÖ B·∫°n ƒë√£ ƒë·ªìng √Ω th√¥ng b√°o #${notification.id}. Gi√° m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh ${negotiatedPrice.toLocaleString()} ƒë.`);


                  try {
                    const removeRes = await fetch(`https://localhost:7238/api/Notification/remove-notification?notificationId=${notification.id}`, {
                      method: "DELETE"
                    });
                    if (removeRes.ok) {
                      console.log("Notification removed successfully");

                      loadNotifications();
                    }
                  } catch (removeErr) {
                    console.error("Error removing notification:", removeErr);
                  }
                } else {
                  alert("‚ùå C·∫≠p nh·∫≠t gi√° th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
                }
              } catch (err) {
                console.error("Error updating product price:", err);
                alert("‚ùå C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t gi√° s·∫£n ph·∫©m.");
              }
              break;
            case "rejected":
              alert(`‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi th√¥ng b√°o #${notification.id}.`);


              try {
                const removeRes = await fetch(`https://localhost:7238/api/Notification/remove-notification?notificationId=${notification.id}`, {
                  method: "DELETE"
                });
                if (removeRes.ok) {
                  console.log("Notification removed successfully");

                  loadNotifications();
                }
              } catch (removeErr) {
                console.error("Error removing notification:", removeErr);
              }
              break;
            case "chat":

              const notificationIdToChat = {
                PriceNegotiationId: notification.relatedId || 1,
                SenderId: notification.senderId || 1,
                ReceiverId: notification.receiverId || 1
              };
              localStorage.removeItem("notificationIdToChat");
              localStorage.setItem("notificationIdToChat", JSON.stringify(notificationIdToChat));
              window.location.href = "chat.html";
              break;
            default:
              alert("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
          }
          document.getElementById("notificationBox").classList.add("hidden");
        };

        document
          .getElementById("notifIcon")
          .addEventListener("click", function (e) {
            e.stopPropagation();
            const notificationBox =
              document.getElementById("notificationBox");
            if (notificationBox.classList.contains("hidden")) {
              loadNotifications();
            }
            notificationBox.classList.toggle("hidden");
            document.getElementById("notifDot").style.display = "none";
          });
      </script>
      <script>

        const user = JSON.parse(localStorage.getItem("user"));
        const userId = user && user.id ? user.id : 1;
        const username = user.fullName || "Mizu";
        document.getElementById("username-link").textContent = username;
      </script>
      <div class="cart-icon-container">
        <i class="fa fa-shopping-bag" id="cartIcon"></i>
        <span class="cart-badge" id="cartCount">0</span>


        <div id="cartPopup" class="cart-popup hidden"></div>
      </div>
      <a href="post.html" class="post-button">ƒêƒÉng b√°n</a>
    </div>
  </div>

    <div class="sub-menu">
      <a href="home.html" class="menu-link">G·ª¢I √ù</a>
      <a href="style.html" class="menu-link">TH·ªúI TRANG</a>
      <a href="book.html" class="menu-link active">S√ÅCH</a>
      <a href="hh.html" class="menu-link">ƒê·ªí GIA D·ª§NG</a>
      <a href="elec.html" class="menu-link">ƒê·ªí ƒêI·ªÜN T·ª¨</a>
      <a href="play.html" class="menu-link">ƒê·ªí GI·∫¢I TR√ç</a>
    </div>

    <section class="latest-products" id="search-results" style="display: none">
      <h2>K·∫æt Qu·∫£ T√¨m Ki·∫øm</h2>
      <div class="suggest-grid" id="searchList"></div>
    </section>

    <section class="latest-products">
      <h2>TI·ªÇU THUY·∫æT</h2>
      <div id="productList" class="suggest-grid"></div>
    </section>
    <section class="latest-products">
      <h2>PHI H∆Ø C·∫§U</h2>
      <div id="productList1" class="suggest-grid"></div>
    </section>
    <section class="latest-products">
      <h2>T·ª∞ L·ª∞C - PH√ÅT TRI·ªÇN B·∫¢N TH√ÇN</h2>
      <div id="productList2" class="suggest-grid"></div>
    </section>
    <section class="latest-products">
      <h2>GI√ÅO D·ª§C - H·ªåC THU·∫¨T</h2>
      <div id="productList3" class="suggest-grid"></div>
    </section>

    <script>
      const subcategories = [5, 6, 7, 8];
      const containerIds = [
        "productList",
        "productList1",
        "productList2",
        "productList3",
      ];

      function formatPrice(price) {
        if (typeof price === "number") price = price.toString();
        price = price.replace(/\D/g, "");
        return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ƒë";
      }

      function renderProduct(container, product) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
        <img src="${product.imageUrl}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>${formatPrice(product.price)}</p>
      `;
        card.onclick = () => {
          localStorage.setItem("selectedProduct", JSON.stringify(product));
          window.location.href = "sp.html";
        };
        container.appendChild(card);
      }

      subcategories.forEach((subCatId, index) => {
        fetch(
          `https://localhost:7238/api/Product/get-subcategory-products?SubCategoryId=${subCatId}&PageNumber=1&PageSize=20`
        )
          .then((res) => res.json())
          .then((data) => {
            const container = document.getElementById(containerIds[index]);
            container.innerHTML = "";
            (data.data || []).forEach((product) =>
              renderProduct(container, product)
            );
          })
          .catch((error) => console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m:", error));
      });

      const searchInput = document.querySelector(".search-bar input");
      searchInput.addEventListener("input", () => {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
          const keyword = searchInput.value.trim();
          const section = document.getElementById("search-results");
          const list = document.getElementById("searchList");

          if (!keyword) {
            section.style.display = "none";
            list.innerHTML = "";
            return;
          }

          fetch(
            `https://localhost:7238/api/Product/search-by-name?PageNumber=1&PageSize=20&Name=${encodeURIComponent(
              keyword
            )}`
          )
            .then((res) => res.json())
            .then((data) => {
              list.innerHTML = "";
              section.style.display = "block";
              const products = data.data || [];
              if (products.length === 0) {
                list.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p.</p>";
                return;
              }
              products.forEach((product) => renderProduct(list, product));
            })
            .catch((err) => {
              section.style.display = "block";
              list.innerHTML = "<p>ƒê√£ x·∫£y ra l·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m.</p>";
              console.error("L·ªói t√¨m ki·∫øm:", err);
            });
        }, 300);
      });
    </script>
    <script>

      const cartCount = document.getElementById("cartCount");
      const cartPopup = document.getElementById("cartPopup");
      let cart = [];

      fetch(`https://localhost:7238/api/Cart/get-items?userId=${userId}`)
        .then((res) => res.json())
        .then((data) => {
          cart = data.data || [];
          updateCartUI();
        })
        .catch((error) => {
          console.error("Error fetching cart items:", error);
        
          cart = JSON.parse(localStorage.getItem("cartItems")) || [];
          updateCartUI();
        });

      function formatPrice(price) {
        if (typeof price === "number") price = price.toString();
        price = price.replace(/\D/g, "");
        return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "ƒë";
      }

      function updateCartUI() {
        cartCount.textContent = cart.length;
        if (cart.length === 0) {
          cartPopup.innerHTML = "<p>üõí Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>";
          return;
        }
        let html = '<h4 style="margin-top:0;">S·∫£n ph·∫©m trong gi·ªè:</h4>';
        let total = 0;

        cart.forEach((item, index) => {
          total += parseInt(item.price);
          html += `
        <div class="cart-item">
          <img src="${item.productImage}" alt="${item.productName}" />
          <div class="cart-item-info" onclick="viewProduct(${index})" style="cursor:pointer;">
            <strong>${item.productName}</strong><br>
            ${formatPrice(item.price)}
          </div>
          <button class="remove-btn" onclick="event.stopPropagation(); removeItem(${index})">‚úï</button>

        </div>
      `;
        });

        html += `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px; gap: 12px;">
        <div class="total-price" style="margin:0;">T·ªïng: ${formatPrice(
          total.toString()
        )}</div>
        <button class="action-button primary" onclick="proceedToPayment()" style="flex-shrink: 0;">Thanh to√°n</button>
      </div>
    `;

        cartPopup.innerHTML = html;
      }

     async function removeItem(index) {
        const itemToRemove = cart[index];
        const user = JSON.parse(localStorage.getItem("user"));
        const userId = user && user.id ? user.id : 1;

        try {
          const response = await fetch(
            `https://localhost:7238/api/Cart/remove-item?userId=${userId}&productId=${itemToRemove.productId}`,
            {
              method: "DELETE",
            }
          );

        
          cart.splice(index, 1);
          localStorage.setItem("cartItems", JSON.stringify(cart));
          updateCartUI();

          if (!response.ok) {
            console.error("Error removing item from server cart");
          }
        } catch (error) {
          console.error("Error calling remove API:", error);
          cart.splice(index, 1);
          localStorage.setItem("cartItems", JSON.stringify(cart));
          updateCartUI();
        }
      }

      updateCartUI();
     



      window.viewProduct = function (index) {
        const item = cart[index];
       
        const product = {
          id: item.productId || item.id,
          name: item.productName || item.name,
          price: item.price,
          imageUrl: item.productImage || item.image || item.imageUrl,
          description: item.description || "",
          categoryId: item.categoryId || 2,
          sellerId: item.sellerId || 0,
          status: item.status || 0,
          isDeleted: item.isDeleted || false,
          createdAt: item.createdAt || new Date().toISOString(),
          condition: item.condition || "",
        };
        localStorage.setItem("selectedProduct", JSON.stringify(product));
        window.location.href = "sp.html";
      };


      window.proceedToPayment = function () {
        if (cart.length === 0) {
          alert("Gi·ªè h√†ng tr·ªëng!");
          return;
        }
        localStorage.setItem("cartToPay", JSON.stringify(cart));
        window.location.href = "pay.html";
      };

      document
        .querySelector(".cart-icon-container")
        .addEventListener("click", (e) => {
          cartPopup.classList.toggle("hidden");
          cartPopup.style.display =
            cartPopup.style.display === "block" ? "none" : "block";
          e.stopPropagation();
        });

      document.addEventListener("click", function (event) {
        const isInside =
          cartPopup.contains(event.target) ||
          event.target.closest(".cart-icon-container");
        if (!isInside) cartPopup.classList.add("hidden");
      });

      updateCartUI();
    </script>

    <footer>
      <p>&copy; 2025 2HandHub.com - All rights reserved.</p>
    </footer>

    <script>
      
      const cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      document.getElementById("cartCount").textContent = cartItems.length;
    </script>

    <script>
      const searchInput = document.getElementById("searchInput");
      const searchSection = document.getElementById("search-results");
      const searchList = document.getElementById("searchList");

      function formatPrice(price) {
        if (typeof price === "number") price = price.toString();
        price = price.replace(/\D/g, "");
        return price.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ƒë";
      }

      function renderProduct(container, product) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
      <img src="${product.imageUrl}" alt="${product.name}">
      <h3>${product.name}</h3>
      <p>${formatPrice(product.price)}</p>
    `;
        card.style.cursor = "pointer";
        card.onclick = function () {
          localStorage.setItem("selectedProduct", JSON.stringify(product));
          window.location.href = "sp.html";
        };
        container.appendChild(card);
      }

      searchInput.addEventListener("input", () => {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
          const keyword = searchInput.value.trim();
          if (!keyword) {
            searchSection.style.display = "none";
            searchList.innerHTML = "";
            return;
          }

          fetch(
            `https://localhost:7238/api/Product/search-by-name?PageNumber=1&PageSize=20&Name=${encodeURIComponent(
              keyword
            )}`
          )
            .then((res) => res.json())
            .then((data) => {
              searchList.innerHTML = "";
              const products = data.data || [];
              searchSection.style.display = "block";
              if (products.length === 0) {
                searchList.innerHTML =
                  "<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p.</p>";
                return;
              }
              products.forEach((product) => renderProduct(searchList, product));
            })
            .catch((err) => {
              searchList.innerHTML =
                "<p>ƒê√£ x·∫£y ra l·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m.</p>";
              searchSection.style.display = "block";
              console.error("L·ªói t√¨m ki·∫øm:", err);
            });
        }, 300);
      });
    </script>
   
    <script>
      document.addEventListener("DOMContentLoaded", function () {
  
        const user = JSON.parse(localStorage.getItem("user"));
        const connection = new signalR.HubConnectionBuilder()
          .withUrl(`https://localhost:7238/notification?userId=${user.id}`) // ho·∫∑c "/hubs/notification" tu·ª≥ c·∫•u h√¨nh server
          .withAutomaticReconnect()
          .configureLogging(signalR.LogLevel.Information)
          .build();

        connection.on("UserConnected", function () {
          console.log("K·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn NotificationHub");
        
        });
      
        connection.on("ReceiveNotification", function (notification) {
          console.log("Th√¥ng b√°o m·ªõi:", notification);

          const notifDot = document.getElementById("notifDot");
          if (notifDot) {
            notifDot.style.display = "block";
          }

       
          if (notification.Title && notification.Message) {
       
            const toast = document.createElement("div");
            toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 300px;
            animation: slideIn 0.3s ease;
          `;
            toast.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 8px;">${notification.Title}</div>
            <div style="font-size: 14px; color: #666;">${notification.Message}</div>
          `;
            document.body.appendChild(toast);

          
            setTimeout(() => {
              toast.remove();
            }, 5000);
          }
        });

      
        connection
          .start()
          .then(function () {
            console.log("ƒê√£ k·∫øt n·ªëi ƒë·∫øn NotificationHub");
           
          })
          .catch(function (err) {
            console.error("L·ªói khi k·∫øt n·ªëi SignalR:", err.toString());
          });
      });
    </script>
  </body>
</html>
